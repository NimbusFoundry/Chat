// Generated by CoffeeScript 1.8.0
(function() {
  var define_controller;

  define('chat', function() {
    return {
      name: 'chat',
      title: 'Chat Room',
      icon: 'icon-comment',
      type: 'plugin',
      anchor: '#/chat',
      init: function() {
        var attrs, self;
        self = this;
        attrs = ['userId', 'userName', 'time', 'image', 'content', 'file', 'avatar'];
        foundry.model('Message', attrs, function(model) {
          return foundry.initialized(self.name);
        });
        return define_controller();
      },
      inited: function() {
        return console.log('end');
      }
    };
  });

  define_controller = function() {
    return angular.module('foundry').controller('ChatController', [
      '$scope', '$filter', function($scope, $filter) {
        var loadUser, messageModel;
        $scope.messages = [];
        $scope.message = '';
        $scope.collaborators = [];
        messageModel = foundry._models['Message'];
        $scope.load = function() {
          var messages, user, users, _i, _len;
          console.log('load all messages 20 at first');
          messages = $filter('orderBy')(messageModel.all(), 'time', false);
          $scope.messages = messages;
          users = doc.getCollaborators();
          $scope.me = null;
          for (_i = 0, _len = users.length; _i < _len; _i++) {
            user = users[_i];
            if (user.isMe) {
              $scope.me = user;
              break;
            }
          }
          return $scope.collaborators = users;
        };
        $scope.send = function() {
          var data;
          console.log('send this');
          if (!$scope.message) {
            return;
          }
          data = {
            userId: foundry._current_user.id,
            userName: foundry._current_user.name,
            content: $scope.message,
            time: new Date().getTime(),
            avatar: $scope.me.photoUrl
          };
          messageModel.create(data);
          $scope.message = '';
          return $scope.load();
        };
        $scope.is_mine_message = function(message) {
          return message.userId === foundry._current_user.id;
        };
        loadUser = function(evt) {
          console.log(evt);
          $scope.users = doc.getCollaborators();
          return $scope.$apply();
        };
        doc.addEventListener(gapi.drive.realtime.EventType.COLLABORATOR_JOINED, loadUser);
        doc.addEventListener(gapi.drive.realtime.EventType.COLLABORATOR_LEFT, loadUser);
        return $scope.load();
      }
    ]);
  };

}).call(this);
